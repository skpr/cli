name: ‚òÅÔ∏è Release

on:
  push:
    tags:
      - '*'

env:
  BUCKET_NAME: package-skpr-io
  AWS_REGION:  us-east-1

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v5

      - name: üì¶ Install Mise
        run: |
          curl https://mise.run | sh
          mise install

      - name: ‚òÅÔ∏è Release
        run: |
          mise release
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

  release_debs:
    runs-on: ubuntu-latest
    needs:
      - release
    steps:
      - name: ‚¨áÔ∏è Git clone the repository
        uses: actions/checkout@v5

      - name: üìÅ Make apt repo dirs
        run: mkdir -p apt-repo/pool/main/skpr

      - name: üì¶ Download latest release
        uses: robinraju/release-downloader@v1.8
        with:
          repository: skpr/cli
          latest: true
          fileName: "*.deb"
          out-file-path: apt-repo/pool/main/skpr

      - name: ‚öôÔ∏è Configure aws credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üîë Import GPG Private Key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: üîê List keys
        run: gpg -K

      - name: üì¶ Generate Apt Repo
        run: |
          cd apt-repo
          ../scripts/generate-apt-repo.sh
          cd -

      - name: üîë Export Public Key
        run: |
          cd apt-repo
          echo "${{ secrets.GPG_PUBLIC_KEY }}" > packages.skpr.io.pub
          cd -

      - name: ‚òÅÔ∏è Sync to S3
        run: |
          cd apt-repo
          aws s3 sync --delete . s3://${{ env.BUCKET_NAME }}/apt/
          cd -

      - name: üßπ Invalidate Cloudfront
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_ID }} --paths /apt/*
